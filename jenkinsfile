pipeline {
    agent any

    stages {
        stage('Initialize') {
            steps {
                script {
                    // Access the DO_API_TOKEN environment variable
                    def doApiToken = env.DO_API_TOKEN
                }
            }
        }
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Init') {
            steps {
                dir('App-server') {
                    sh 'sudo terraform init'
                    sh "echo ${DO_API_TOKEN}"
                }
            }
        }
        stage('Plan') {
            steps {
                dir('App-server') {
                    withEnv(["DO_TOKEN=${env.DO_API_TOKEN}"]) {
                        sh "sudo terraform plan -var='do_api_token=${env.DO_API_TOKEN}' -auto-approve"
}                }
            }
        }

        stage('Apply') {
            steps {
                dir('App-server') {
                    sh "sudo terraform apply -var='do_api_token=${env.DO_API_TOKEN}' -auto-approve"
                }
            }
        }

        
    }
}